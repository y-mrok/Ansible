[root@awx ~]# curl -sfL https://get.k3s.io | sh
[INFO]  Finding release for channel stable
[INFO]  Using v1.21.1+k3s1 as release
[INFO]  Downloading hash https://github.com/k3s-io/k3s/releases/download/v1.21.1+k3s1/sha256sum-amd6
4.txt
[INFO]  Downloading binary https://github.com/k3s-io/k3s/releases/download/v1.21.1+k3s1/k3s
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
Rancher K3s Common (stable)                                         834  B/s | 1.2 kB     00:01    
依存関係が解決しました。
====================================================================================================
 パッケージ        Arch   バージョン                                リポジトリー              サイズ
====================================================================================================
インストール:
 k3s-selinux       noarch 0.3-0.el8                                 rancher-k3s-common-stable  18 k
依存関係のインストール:
 container-selinux noarch 2:2.162.0-1.module_el8.4.0+830+8027e1c4   appstream                  52 k
モジュールストリームの有効化中:
 container-tools          rhel8                                                                    

（中略）

インストール済み:
  container-selinux-2:2.162.0-1.module_el8.4.0+830+8027e1c4.noarch   k3s-selinux-0.3-0.el8.noarch  

完了しました!
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.se
rvice.
[INFO]  systemd: Starting k3s
[root@awx ~]# cat /etc/systemd/system/k3s.service
[Unit]
Description=Lightweight Kubernetes
Documentation=https://k3s.io
Wants=network-online.target
After=network-online.target

[Install]
WantedBy=multi-user.target

[Service]
Type=notify
EnvironmentFile=-/etc/default/%N
EnvironmentFile=-/etc/sysconfig/%N
EnvironmentFile=-/etc/systemd/system/k3s.service.env
KillMode=process
Delegate=yes
# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNOFILE=1048576
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
TimeoutStartSec=0
Restart=always
RestartSec=5s
ExecStartPre=/bin/sh -xc '! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service'
ExecStartPre=-/sbin/modprobe br_netfilter
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/k3s \
    server \

[root@awx ~]# systemctl status k3s
● k3s.service - Lightweight Kubernetes
   Loaded: loaded (/etc/systemd/system/k3s.service; enabled; vendor preset: disabled)
   Active: active (running) since Wed 2021-06-23 21:38:03 JST; 1min 4s ago
     Docs: https://k3s.io
  Process: 2501 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)
  Process: 2494 ExecStartPre=/sbin/modprobe br_netfilter (code=exited, status=0/SUCCESS)
  Process: 2491 ExecStartPre=/bin/sh -xc ! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.ser>
 Main PID: 2503 (k3s-server)
    Tasks: 98
   Memory: 1.2G
   CGroup: /system.slice/k3s.service
           ├─2503 /usr/local/bin/k3s server
           ├─2533 containerd 
           ├─3048 /var/lib/rancher/k3s/data/77457d0b09d8b94d6f5029bcbc70f94b7ae9c50a08b539b76612e71>
           ├─3073 /var/lib/rancher/k3s/data/77457d0b09d8b94d6f5029bcbc70f94b7ae9c50a08b539b76612e71>
           ├─3077 /var/lib/rancher/k3s/data/77457d0b09d8b94d6f5029bcbc70f94b7ae9c50a08b539b76612e71>
           ├─4156 /var/lib/rancher/k3s/data/77457d0b09d8b94d6f5029bcbc70f94b7ae9c50a08b539b76612e71>
           └─4334 /var/lib/rancher/k3s/data/77457d0b09d8b94d6f5029bcbc70f94b7ae9c50a08b539b76612e71>

 6月 23 21:38:51 awx.example.jp k3s[2503]: I0623 21:38:51.230576    2503 reconciler.go:196] "operat>
 6月 23 21:38:51 awx.example.jp k3s[2503]: I0623 21:38:51.230608    2503 reconciler.go:196] "operat>
 6月 23 21:38:51 awx.example.jp k3s[2503]: W0623 21:38:51.230892    2503 empty_dir.go:520] Warning:>
 6月 23 21:38:51 awx.example.jp k3s[2503]: W0623 21:38:51.231703    2503 empty_dir.go:520] Warning:>
 6月 23 21:38:51 awx.example.jp k3s[2503]: I0623 21:38:51.231930    2503 operation_generator.go:829>
 6月 23 21:38:51 awx.example.jp k3s[2503]: I0623 21:38:51.232145    2503 operation_generator.go:829>
 6月 23 21:38:51 awx.example.jp k3s[2503]: I0623 21:38:51.245708    2503 operation_generator.go:829>
 6月 23 21:38:51 awx.example.jp k3s[2503]: I0623 21:38:51.331499    2503 reconciler.go:319] "Volume>
 6月 23 21:38:51 awx.example.jp k3s[2503]: I0623 21:38:51.331587    2503 reconciler.go:319] "Volume>
 6月 23 21:38:51 awx.example.jp k3s[2503]: I0623 21:38:51.331616    2503 reconciler.go:319] "Volume>
[root@awx ~]# kubectl get nodes
NAME             STATUS   ROLES                  AGE   VERSION
awx.example.jp   Ready    control-plane,master   73s   v1.21.1+k3s1
[root@awx ~]# kubectl get pods --all-namespaces
NAMESPACE     NAME                                      READY   STATUS      RESTARTS   AGE
kube-system   coredns-7448499f4d-j9msp                  1/1     Running     0          8m38s
kube-system   metrics-server-86cbb8457f-2xcjn           1/1     Running     0          8m38s
kube-system   local-path-provisioner-5ff76fc89d-cpvz9   1/1     Running     0          8m38s
kube-system   helm-install-traefik-crd-m8q8v            0/1     Completed   0          8m38s
kube-system   helm-install-traefik-xvhn2                0/1     Completed   1          8m38s
kube-system   svclb-traefik-crrbq                       2/2     Running     0          8m6s
kube-system   traefik-97b44b794-s999w                   1/1     Running     0          8m6s
[root@awx ~]# kubectl config set-context --current --namespace=default
Context "default" modified.
[root@awx ~]# kubectl apply -f https://raw.githubusercontent.com/ansible/awx-operator/0.10.0/deploy/
awx-operator.yaml
customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com created
customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com created
customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com created
clusterrole.rbac.authorization.k8s.io/awx-operator created
clusterrolebinding.rbac.authorization.k8s.io/awx-operator created
serviceaccount/awx-operator created
deployment.apps/awx-operator created
[root@awx ~]# kubectl get events -w --all-namespaces
NAMESPACE     LAST SEEN   TYPE      REASON                    OBJECT                                
         MESSAGE
default       9m21s       Normal    Starting                  node/awx.example.jp                   
         Starting kubelet.
default       9m21s       Warning   InvalidDiskCapacity       node/awx.example.jp                   
         invalid capacity 0 on image filesystem
default       9m21s       Normal    NodeHasSufficientMemory   node/awx.example.jp                   
         Node awx.example.jp status is now: NodeHasSufficientMemory
default       9m21s       Normal    NodeHasNoDiskPressure     node/awx.example.jp                   
         Node awx.example.jp status is now: NodeHasNoDiskPressure

（中略）


default       9s          Normal    Scheduled                 pod/awx-operator-75c79f5489-62lbb     
         Successfully assigned default/awx-operator-75c79f5489-62lbb to awx.example.jp
default       9s          Normal    Pulling                   pod/awx-operator-75c79f5489-62lbb     
         Pulling image "quay.io/ansible/awx-operator:0.10.0"
default       0s          Normal    Pulled                    pod/awx-operator-75c79f5489-62lbb     
         Successfully pulled image "quay.io/ansible/awx-operator:0.10.0" in 24.289586903s
default       0s          Normal    Created                   pod/awx-operator-75c79f5489-62lbb     
         Created container awx-operator
default       0s          Normal    Started                   pod/awx-operator-75c79f5489-62lbb     
         Started container awx-operator
^C[root@awx ~]# kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
awx-operator-75c79f5489-62lbb   1/1     Running   0          3m26s
[root@awx ~]# kubectl logs -f deployment.apps/awx-operator
{"level":"info","ts":1624452462.4707985,"logger":"cmd","msg":"Go Version: go1.13.15"}
{"level":"info","ts":1624452462.4709737,"logger":"cmd","msg":"Go OS/Arch: linux/amd64"}
{"level":"info","ts":1624452462.4710875,"logger":"cmd","msg":"Version of ansible-operator: v0.19.4"}
{"level":"info","ts":1624452462.471164,"logger":"cmd","msg":"Git commit of ansible-operator: 125d0df
cc71fef4f9d7e2a42b1354cb79ffdee03"}
{"level":"info","ts":1624452462.4718332,"logger":"cmd","msg":"Watching all namespaces.","Namespace":
""}
{"level":"info","ts":1624452463.2776682,"logger":"controller-runtime.metrics","msg":"metrics server 
is starting to listen","addr":"0.0.0.0:8383"}
{"level":"info","ts":1624452463.2785845,"logger":"watches","msg":"Environment variable not set; usin
g default value","envVar":"WORKER_AWX_AWX_ANSIBLE_COM","default":1}

（中略）

{"level":"info","ts":1624452468.1431108,"logger":"controller-runtime.controller","msg":"Starting Eve
ntSource","controller":"awx-controller","source":"kind source: awx.ansible.com/v1beta1, Kind=AWX"}
{"level":"info","ts":1624452468.2454379,"logger":"controller-runtime.controller","msg":"Starting Con
troller","controller":"awxrestore-controller"}
{"level":"info","ts":1624452468.2454855,"logger":"controller-runtime.controller","msg":"Starting wor
kers","controller":"awxrestore-controller","worker count":1}
{"level":"info","ts":1624452468.2457247,"logger":"controller-runtime.controller","msg":"Starting Con
troller","controller":"awxbackup-controller"}
{"level":"info","ts":1624452468.2457676,"logger":"controller-runtime.controller","msg":"Starting wor
kers","controller":"awxbackup-controller","worker count":1}
{"level":"info","ts":1624452468.2467782,"logger":"controller-runtime.controller","msg":"Starting Con
troller","controller":"awx-controller"}
{"level":"info","ts":1624452468.2468538,"logger":"controller-runtime.controller","msg":"Starting wor
kers","controller":"awx-controller","worker count":1}
^C
[root@awx ~]# kubectl create namespace awx
namespace/awx created
[root@awx ~]# kubectl config set-context --current --namespace=awx
Context "default" modified.
[root@awx ~]# vi myawx.yml
[root@awx ~]# cat myawx.yml
---
apiVersion: awx.ansible.com/v1beta1
kind: AWX
metadata:
  name: awx
spec:
  ingress_type: Ingress
  route_tls_termination_mechanism: edge
  hostname: awx.example.jp

[root@awx ~]# kubectl apply -f myawx.yml
awx.awx.ansible.com/awx created
[root@awx ~]# kubectl get events -w --all-namespaces
NAMESPACE     LAST SEEN   TYPE      REASON                    OBJECT                                
         MESSAGE
default       15m         Normal    Starting                  node/awx.example.jp                   
         Starting kubelet.
default       15m         Warning   InvalidDiskCapacity       node/awx.example.jp                   
         invalid capacity 0 on image filesystem
default       15m         Normal    NodeHasSufficientMemory   node/awx.example.jp                   
         Node awx.example.jp status is now: NodeHasSufficientMemory
default       15m         Normal    NodeHasNoDiskPressure     node/awx.example.jp                   
         Node awx.example.jp status is now: NodeHasNoDiskPressure

（中略）

default       6m13s       Normal    Created                   pod/awx-operator-75c79f5489-62lbb     
         Created container awx-operator
default       6m13s       Normal    Started                   pod/awx-operator-75c79f5489-62lbb     
         Started container awx-operator
awx           0s          Normal    SuccessfulCreate          statefulset/awx-postgres              
         create Claim postgres-awx-postgres-0 Pod awx-postgres-0 in StatefulSet awx-postgres success
awx           0s          Normal    SuccessfulCreate          statefulset/awx-postgres              
         create Pod awx-postgres-0 in StatefulSet awx-postgres successful
awx           0s          Normal    WaitForFirstConsumer      persistentvolumeclaim/postgres-awx-pos
tgres-0   waiting for first consumer to be created before binding
awx           0s          Normal    ExternalProvisioning      persistentvolumeclaim/postgres-awx-pos
tgres-0   waiting for a volume to be created, either by external provisioner "rancher.io/local-path"
 or manually created by system administrator
awx           0s          Normal    ExternalProvisioning      persistentvolumeclaim/postgres-awx-pos
tgres-0   waiting for a volume to be created, either by external provisioner "rancher.io/local-path"
 or manually created by system administrator
awx           0s          Normal    Provisioning              persistentvolumeclaim/postgres-awx-pos
tgres-0   External provisioner is provisioning volume for claim "awx/postgres-awx-postgres-0"
awx           0s          Normal    ExternalProvisioning      persistentvolumeclaim/postgres-awx-pos
tgres-0   waiting for a volume to be created, either by external provisioner "rancher.io/local-path"
 or manually created by system administrator
kube-system   0s          Normal    Pulling                   pod/helper-pod-create-pvc-7d2733ad-bbb
5-4085-b4d3-41817d1f8498   Pulling image "rancher/library-busybox:1.32.1"
kube-system   0s          Normal    Pulled                    pod/helper-pod-create-pvc-7d2733ad-bbb
5-4085-b4d3-41817d1f8498   Successfully pulled image "rancher/library-busybox:1.32.1" in 4.747771925
s
kube-system   0s          Normal    Created                   pod/helper-pod-create-pvc-7d2733ad-bbb
5-4085-b4d3-41817d1f8498   Created container helper-pod
kube-system   0s          Normal    Started                   pod/helper-pod-create-pvc-7d2733ad-bbb
5-4085-b4d3-41817d1f8498   Started container helper-pod
awx           0s          Normal    ProvisioningSucceeded     persistentvolumeclaim/postgres-awx-pos
tgres-0                    Successfully provisioned volume pvc-7d2733ad-bbb5-4085-b4d3-41817d1f8498
awx           0s          Normal    Scheduled                 pod/awx-postgres-0                    
                           Successfully assigned awx/awx-postgres-0 to awx.example.jp
awx           0s          Normal    Pulling                   pod/awx-postgres-0                    
                           Pulling image "postgres:12"
awx           0s          Normal    ScalingReplicaSet         deployment/awx                        
                           Scaled up replica set awx-6d97bb8b9f to 1
awx           0s          Normal    SuccessfulCreate          replicaset/awx-6d97bb8b9f             
                           Created pod: awx-6d97bb8b9f-s4z5t
awx           0s          Normal    Scheduled                 pod/awx-6d97bb8b9f-s4z5t              
                           Successfully assigned awx/awx-6d97bb8b9f-s4z5t to awx.example.jp
awx           0s          Normal    Pulling                   pod/awx-6d97bb8b9f-s4z5t              
                           Pulling image "docker.io/redis:latest"
awx           0s          Normal    Pulled                    pod/awx-6d97bb8b9f-s4z5t              
                           Successfully pulled image "docker.io/redis:latest" in 7.096207056s
awx           0s          Normal    Created                   pod/awx-6d97bb8b9f-s4z5t              
                           Created container redis
awx           0s          Normal    Started                   pod/awx-6d97bb8b9f-s4z5t              
                           Started container redis
awx           0s          Normal    Pulling                   pod/awx-6d97bb8b9f-s4z5t              
                           Pulling image "quay.io/ansible/awx:19.2.0"
awx           0s          Normal    Pulled                    pod/awx-postgres-0                    
                           Successfully pulled image "postgres:12" in 16.409029626s
awx           0s          Normal    Created                   pod/awx-postgres-0                    
                           Created container postgres
awx           0s          Normal    Started                   pod/awx-postgres-0                    
                           Started container postgres
awx           0s          Normal    Pulled                    pod/awx-6d97bb8b9f-s4z5t              
                           Successfully pulled image "quay.io/ansible/awx:19.2.0" in 38.545021461s
awx           0s          Normal    Created                   pod/awx-6d97bb8b9f-s4z5t              
                           Created container awx-web
awx           0s          Normal    Started                   pod/awx-6d97bb8b9f-s4z5t              
                           Started container awx-web
awx           0s          Normal    Pulled                    pod/awx-6d97bb8b9f-s4z5t              
                           Container image "quay.io/ansible/awx:19.2.0" already present on machine
awx           0s          Normal    Created                   pod/awx-6d97bb8b9f-s4z5t              
                           Created container awx-task
awx           0s          Normal    Started                   pod/awx-6d97bb8b9f-s4z5t              
                           Started container awx-task
awx           0s          Normal    Pulling                   pod/awx-6d97bb8b9f-s4z5t              
                           Pulling image "quay.io/ansible/awx-ee:0.3.0"
awx           0s          Normal    Pulled                    pod/awx-6d97bb8b9f-s4z5t              
                           Successfully pulled image "quay.io/ansible/awx-ee:0.3.0" in 47.595402606s
awx           0s          Normal    Created                   pod/awx-6d97bb8b9f-s4z5t              
                           Created container awx-ee
awx           0s          Normal    Started                   pod/awx-6d97bb8b9f-s4z5t              
                           Started container awx-ee
^C[root@awx ~]# kubectl logs -f deployment.apps/awx-operator -n default
{"level":"info","ts":1624452462.4707985,"logger":"cmd","msg":"Go Version: go1.13.15"}
{"level":"info","ts":1624452462.4709737,"logger":"cmd","msg":"Go OS/Arch: linux/amd64"}
{"level":"info","ts":1624452462.4710875,"logger":"cmd","msg":"Version of ansible-operator: v0.19.4"}
{"level":"info","ts":1624452462.471164,"logger":"cmd","msg":"Git commit of ansible-operator: 125d0df
cc71fef4f9d7e2a42b1354cb79ffdee03"}
{"level":"info","ts":1624452462.4718332,"logger":"cmd","msg":"Watching all namespaces.","Namespace":
""}
{"level":"info","ts":1624452463.2776682,"logger":"controller-runtime.metrics","msg":"metrics server 
is starting to listen","addr":"0.0.0.0:8383"}
{"level":"info","ts":1624452463.2785845,"logger":"watches","msg":"Environment variable not set; usin
g default value","envVar":"WORKER_AWX_AWX_ANSIBLE_COM","default":1}

（中略）

{"level":"info","ts":1624453218.18947,"logger":"proxy","msg":"Read object from cache","resource":{"I
sResourceRequest":true,"Path":"/api/v1/namespaces/awx/secrets/awx-broadcast-websocket","Verb":"get",
"APIPrefix":"api","APIGroup":"","APIVersion":"v1","Namespace":"awx","Resource":"secrets","Subresourc
e":"","Name":"awx-broadcast-websocket","Parts":["secrets","awx-broadcast-websocket"]}}
{"level":"info","ts":1624453218.5074484,"logger":"runner","msg":"Ansible-runner exited successfully"
,"job":"5486140987150761883","name":"awx","namespace":"awx"}

--------------------------- Ansible Task Status Event StdOut  -----------------

PLAY RECAP *********************************************************************
localhost                  : ok=49   changed=2    unreachable=0    failed=0    skipped=34   rescued=
0    ignored=0   


-------------------------------------------------------------------------------
^C
[root@awx ~]# kubectl get pods
NAME                   READY   STATUS    RESTARTS   AGE
awx-postgres-0         1/1     Running   0          15m
awx-6d97bb8b9f-s4z5t   4/4     Running   0          14m
[root@awx ~]# kubectl get svc
NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
awx-postgres   ClusterIP   None            <none>        5432/TCP   15m
awx-service    ClusterIP   10.43.119.138   <none>        80/TCP     15m
[root@awx ~]# kubectl get secret awx-admin-password -o jsonpath='{.data.password}' | base64 --decode
Vsybh2z7SXwr4yo7GVBVPafPWc2vgZKW[root@awx ~]# 
